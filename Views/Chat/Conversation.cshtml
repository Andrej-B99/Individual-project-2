@model List<MasterServicePlatform.Web.Models.Message>

@{
    ViewData["Title"] = "Chat";

    var currentUserId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
    var dialogs = ViewBag.Dialogs as List<MasterServicePlatform.Web.Models.ViewModels.ChatConversationViewModel>;

    bool chatSelected = !string.IsNullOrEmpty(ViewBag.OtherId);

}

<div class="chat-container d-flex" style="height:80vh; border:1px solid #e5e5e5; border-radius:6px;">

    <!-- LEFT SIDE -->
    <div style="width:28%; border-right:1px solid #ddd; overflow-y:auto; background:#fafafa;">
        <h5 class="p-3 border-bottom">Chats</h5>

        @if (dialogs != null && dialogs.Any())
        {
            foreach (var d in dialogs)
            {
                <a href="/Chat/Conversation?userId=@d.UserId"
                   class="d-block p-3 border-bottom text-decoration-none chat-dialog-item"
                   style="color:#333;">
                    <div class="fw-bold">@d.UserName</div>
                    <div class="text-muted small">@d.LastMessage</div>
                </a>
            }
        }
        else
        {
            <p class="p-3 text-muted">No conversations yet.</p>
        }
    </div>

    <!-- RIGHT SIDE -->
    <div class="flex-grow-1 d-flex flex-column">

        @if (!chatSelected)
        {
            <div class="d-flex justify-content-center align-items-center h-100 text-muted">
                <h5>Select a conversation</h5>
            </div>
        }
        else
        {
            <div class="p-3 border-bottom bg-white d-flex justify-content-between align-items-center">
                <h5 class="m-0">
                    @(ViewBag.OtherId == ViewBag.SupportId
                                    ? "Support Chat"
                                    : $"Chat with {ViewBag.OtherName}")
            </h5>


                <a href="/Chat/Conversation" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-x-lg"></i>
                </a>
            </div>

            <!-- MESSAGES -->
            <div id="chatWindow" style="flex-grow:1; overflow-y:auto; padding:20px; background:white;">
                @foreach (var m in Model)
                {
                    bool mine = m.SenderId == currentUserId;
                    string justify = mine ? "justify-content-end" : "justify-content-start";
                    string bubbleColor = mine ? "#d1e7ff" : "#f1f1f1";

                    <div class="d-flex @justify mb-3 message-wrapper"
                         data-id="@m.Id"
                         data-text="@m.Text">

                        <div class="message-bubble p-2 rounded position-relative"
                             style="background:@bubbleColor; max-width:60%;">

                            <!-- Actions inside bubble -->
                            @if (mine)
                            {
                                <div class="message-actions position-absolute"
                                     style="top:-8px; right:-8px; display:none;">


                                    <button class="btn btn-sm p-0 text-primary edit-btn"
                                            title="Edit"
                                            data-id="@m.Id"
                                            data-text="@m.Text">
                                        <i class="bi bi-pencil"></i>
                                    </button>

                                    <button class="btn btn-sm p-0 text-danger delete-btn"
                                            title="Delete"
                                            data-id="@m.Id">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            }

                            <div>@m.Text</div>

                            <div class="text-muted small mt-1" style="font-size:11px;">
                                @m.SentAt.ToLocalTime()
                                @if (m.EditedAt != null)
                                {
                                    <span class="fst-italic">(edited)</span>
                                }
                            </div>
                        </div>

                    </div>
                }
            </div>

            <!-- INPUT AREA -->
            <div class="p-3 border-top bg-white">
                <div class="input-group">
                    <button class="btn btn-outline-secondary" id="emojiBtn">
                        <i class="bi bi-emoji-smile"></i>
                    </button>

                    <input id="messageInput" class="form-control" placeholder="Type message..." />
                    <button id="sendBtn" class="btn btn-primary">Send</button>
                </div>

                <div id="emojiPicker" class="border p-2 mt-2 bg-white shadow-sm"
                     style="display:none; max-width:250px;">
                </div>
            </div>

            <!-- EDIT MODAL -->
            <div class="modal fade" id="editModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5>Edit message</h5>
                            <button class="btn-close" data-bs-dismiss="modal"></button>
                        </div>

                        <div class="modal-body">
                            <input type="hidden" id="editMessageId" />
                            <textarea id="editMessageText" class="form-control" rows="3"></textarea>
                        </div>

                        <div class="modal-footer">
                            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button class="btn btn-primary" id="saveEditBtn">Save</button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>

</div>

<style>
    .chat-dialog-item:hover {
        background: #e9ecef;
    }

    .message-bubble:hover .message-actions {
        display: block !important;
    }

    .message-actions {
        background: rgba(255,255,255,0.8);
        border-radius: 6px;
        padding: 2px 4px;
        gap: 4px;
    }

        .message-actions button {
            font-size: 14px;
        }

</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>

<script>

    const receiverId = "@ViewBag.OtherId";
    const senderId = "@currentUserId";
    const chatWindow = document.getElementById("chatWindow");

    // ========================================
    // SIGNALR CONNECTION
    // ========================================

    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/chatHub")
        .build();

    connection.on("ReceiveMessage", function (sender, message, messageId) {

        const mine = sender === senderId;
        const justify = mine ? "justify-content-end" : "justify-content-start";
        const bubbleColor = mine ? "#d1e7ff" : "#f1f1f1";

        const wrapper = document.createElement("div");
        wrapper.className = `d-flex ${justify} mb-3 message-wrapper`;
        wrapper.dataset.id = messageId;
        wrapper.dataset.text = message;

        const bubble = document.createElement("div");
        bubble.className = "message-bubble p-2 rounded position-relative";
        bubble.style.background = bubbleColor;
        bubble.style.maxWidth = "60%";
        bubble.innerHTML = `<div>${message}</div>
                            <div class="text-muted small mt-1" style="font-size:11px;">just now</div>`;

        if (mine) {
            bubble.innerHTML += `
                <div class="message-actions position-absolute"
                     style="top:4px; right:6px; display:none;">

                    <button class="btn btn-sm p-0 text-primary edit-btn"
                            title="Edit"
                            data-id="${messageId}"
                            data-text="${message}">
                        <i class="bi bi-pencil"></i>
                    </button>

                    <button class="btn btn-sm p-0 text-danger delete-btn"
                            title="Delete"
                            data-id="${messageId}">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
        }

        wrapper.appendChild(bubble);
        chatWindow.appendChild(wrapper);

        enableActions(wrapper);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    });

    connection.start();

    document.getElementById("sendBtn").onclick = async () => {
        const text = messageInput.value;
        if (!text) return;

        await connection.invoke("SendMessage", receiverId, text);
        messageInput.value = "";
    };

    // ========================================
    // MESSAGE ACTIONS (EDIT/DELETE)
    // ========================================

    function enableActions(msg) {
        msg.onmouseenter = () => {
            let a = msg.querySelector(".message-actions");
            if (a) a.style.display = "block";
        };
        msg.onmouseleave = () => {
            let a = msg.querySelector(".message-actions");
            if (a) a.style.display = "none";
        };

        let deleteBtn = msg.querySelector(".delete-btn");
        if (deleteBtn) {
            deleteBtn.onclick = async () => {
                await fetch(`/Chat/DeleteMessage?id=${deleteBtn.dataset.id}`, { method: "POST" });
                msg.remove();
            };
        }

        let editBtn = msg.querySelector(".edit-btn");
        if (editBtn) {
            editBtn.onclick = () => {
                document.getElementById("editMessageId").value = editBtn.dataset.id;
                document.getElementById("editMessageText").value = editBtn.dataset.text;
                new bootstrap.Modal(document.getElementById('editModal')).show();
            };
        }
    }

    document.querySelectorAll(".message-wrapper").forEach(enableActions);

    // SAVE EDIT
    document.getElementById("saveEditBtn").onclick = async () => {
        const id = editMessageId.value;
        const text = editMessageText.value;

        await fetch(`/Chat/EditMessage?id=${id}&newText=${encodeURIComponent(text)}`, { method: "POST" });

        location.reload();
    };

    // ========================================
    // EMOJI PICKER
    // ========================================

    const emojiPicker = document.getElementById("emojiPicker");
    const emojiBtn = document.getElementById("emojiBtn");

    const emojis = ["😀","😁","😂","🤣","😍","😎","😭","🤯","😡","👍","🙏","💯","🔥"];

    emojis.forEach(e => {
        let b = document.createElement("button");
        b.className = "btn btn-sm";
        b.innerText = e;
        b.onclick = () => messageInput.value += e;
        emojiPicker.appendChild(b);
    });

    emojiBtn.onclick = () => {
        emojiPicker.style.display =
            emojiPicker.style.display === "none" ? "block" : "none";
    };

        messageInput.addEventListener("keydown", async (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (!text) return;

            await connection.invoke("SendMessage", receiverId, text);
            messageInput.value = "";
        }
    });

        connection.on("RefreshDialogs", () => {
        location.reload();
    });

</script>
