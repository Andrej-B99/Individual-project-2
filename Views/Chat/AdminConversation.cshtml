@model List<MasterServicePlatform.Web.Models.Message>

@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["Title"] = "Support Chat";

    var currentUserId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
    var dialogs = ViewBag.Dialogs as List<MasterServicePlatform.Web.Models.ViewModels.ChatConversationViewModel>;
    bool chatSelected = !string.IsNullOrEmpty(ViewBag.OtherId);

}

<div class="row" style="height:85vh;">

    <!-- LEFT PANEL -->
    <div class="col-3 border-end bg-light" style="overflow-y:auto;">
        <h5 class="p-3 border-bottom">Support Inbox</h5>

        @if (dialogs != null && dialogs.Any())
        {
            foreach (var d in dialogs)
            {
                <a href="/Chat/Conversation?userId=@d.UserId"
                   class="d-block p-3 border-bottom text-decoration-none text-dark">
                    <div class="fw-bold">@d.UserName</div>
                    <div class="text-muted small">@d.LastMessage</div>
                </a>
            }
        }
        else
        {
            <div class="p-3 text-muted">No conversations</div>
        }
    </div>


    <!-- RIGHT PANEL -->
    <div class="col-9 d-flex flex-column">

        @if (!chatSelected)
        {
            <!-- Placeholder screen -->
            <div class="d-flex justify-content-center align-items-center h-100 text-muted">
                <h5>Select a conversation</h5>
            </div>
        }
        else
        {
            <!-- HEADER -->
            <div class="p-3 border-bottom bg-white d-flex justify-content-between align-items-center">
                <h5 class="m-0">Chat with @ViewBag.OtherName</h5>

                <a href="/Chat/Conversation" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-x-lg"></i>
                </a>
            </div>

            <!-- MESSAGES -->
            <div id="chatWindow" class="flex-grow-1 p-3 bg-white" style="overflow-y:auto;">
                @foreach (var m in Model)
                {
                    bool mine = m.SenderId == currentUserId;
                    string justify = mine ? "justify-content-end" : "justify-content-start";
                    string bubbleColor = mine ? "#d1e7ff" : "#f1f1f1";

                    <div class="d-flex @justify mb-3 message-wrapper position-relative"
                         data-id="@m.Id"
                         data-text="@m.Text">

                        <!-- ACTION ICONS (same style as user chat) -->
                        @if (mine)
                        {
                            <div class="message-actions position-absolute"
                                 style="top:4px; right:-34px; display:none;">

                                <button class="btn btn-sm p-0 text-primary edit-btn"
                                        title="Edit"
                                        data-id="@m.Id"
                                        data-text="@m.Text">
                                    <i class="bi bi-pencil"></i>
                                </button>

                                <button class="btn btn-sm p-0 text-danger delete-btn"
                                        title="Delete"
                                        data-id="@m.Id">
                                    <i class="bi bi-trash"></i>
                                </button>

                            </div>
                        }

                        <!-- MESSAGE BUBBLE -->
                        <div class="message-bubble p-2 rounded"
                             style="max-width:60%; background:@bubbleColor;">
                            <div>@m.Text</div>

                            <div class="text-muted small mt-1" style="font-size:11px;">
                                @m.SentAt.ToLocalTime()
                                @if (m.EditedAt != null)
                                {
                                    <span class="fst-italic">(edited)</span>
                                }
                            </div>
                        </div>

                    </div>
                }
            </div>


            <!-- INPUT -->
            <div class="p-3 border-top bg-light">
                <div class="input-group">
                    <button class="btn btn-outline-secondary" id="emojiBtn">
                        <i class="bi bi-emoji-smile"></i>
                    </button>
                    <input id="messageInput" class="form-control" placeholder="Type message..." />
                    <button id="sendBtn" class="btn btn-primary">Send</button>
                </div>

                <div id="emojiPicker"
                     class="border p-2 mt-2 bg-white shadow-sm"
                     style="display:none; max-width:250px;">
                </div>
            </div>
        }

    </div>
</div>


<!-- MODAL FOR EDITING -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Edit message</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="editMessageId" />
                <textarea id="editMessageText" class="form-control" rows="3"></textarea>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" id="saveEditBtn">Save</button>
            </div>
        </div>
    </div>
</div>



@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>

    <script>
        const senderId = "@currentUserId";
        const receiverId = "@ViewBag.OtherId";

        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub")
            .build();


        // RECEIVE MESSAGE
        connection.on("ReceiveMessage", (sender, message) => {
            if (!receiverId) return;

            const chat = document.getElementById("chatWindow");

            const wrap = document.createElement("div");
            wrap.classList.add("mb-3");
            wrap.style.textAlign = sender === senderId ? "right" : "left";

            const bubble = document.createElement("div");
            bubble.classList.add("d-inline-block", "p-2", "rounded");
            bubble.style.maxWidth = "70%";
            bubble.style.background = sender === senderId ? "#d1e7ff" : "#f1f1f1";
            bubble.innerText = message;

            wrap.appendChild(bubble);
            chat.appendChild(wrap);
            chat.scrollTop = chat.scrollHeight;
        });

        connection.start();


        // SEND MESSAGE
        document.getElementById("sendBtn").onclick = async () => {
            const text = document.getElementById("messageInput").value;
            if (!text) return;

            await connection.invoke("SendMessage", receiverId, text);
            document.getElementById("messageInput").value = "";
        };

        document.getElementById("messageInput").addEventListener("keydown", async (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                document.getElementById("sendBtn").click();
            }
        });


        // EMOJI PICKER
        const emojiBtn = document.getElementById("emojiBtn");
        const emojiPicker = document.getElementById("emojiPicker");
        const messageInput = document.getElementById("messageInput");

        const emojis = ["😀", "😁", "😂", "😍", "😎", "😭", "🤯", "😡", "👍", "🙏", "🔥", "💯", "❤️"];

        emojis.forEach(e => {
            let b = document.createElement("button");
            b.className = "btn btn-sm";
            b.innerText = e;
            b.onclick = () => messageInput.value += e;
            emojiPicker.appendChild(b);
        });

        emojiBtn.onclick = () => {
            emojiPicker.style.display = emojiPicker.style.display === "none" ? "block" : "none";
        };


        // SHOW ACTIONS ON HOVER
        document.querySelectorAll(".message-wrapper").forEach(msg => {
            msg.onmouseenter = () => {
                let actions = msg.querySelector(".message-actions");
                if (actions) actions.style.display = "block";
            };
            msg.onmouseleave = () => {
                let actions = msg.querySelector(".message-actions");
                if (actions) actions.style.display = "none";
            };
        });


        // DELETE MESSAGE
        document.querySelectorAll(".delete-btn").forEach(btn => {
            btn.onclick = async () => {
                let id = btn.dataset.id;
                await fetch("/Chat/DeleteMessage?id=" + id, { method: "POST" });
                location.reload();
            };
        });


        // EDIT MESSAGE
        const editModal = new bootstrap.Modal(document.getElementById("editModal"));

        document.querySelectorAll(".edit-btn").forEach(btn => {
            btn.onclick = () => {
                document.getElementById("editMessageId").value = btn.dataset.id;
                document.getElementById("editMessageText").value = btn.dataset.text;
                editModal.show();
            };
        });

        document.getElementById("saveEditBtn").onclick = async () => {
            const id = document.getElementById("editMessageId").value;
            const text = document.getElementById("editMessageText").value;

            await fetch("/Chat/EditMessage?id=" + id + "&newText=" + encodeURIComponent(text), {
                method: "POST"
            });

            editModal.hide();
            location.reload();
        };

                connection.on("RefreshDialogs", () => {
            location.reload();
        });

    </script>
}

<style>
    .message-wrapper {
        padding-right: 40px; /* space for icons */
    }

        .message-wrapper:hover .message-actions {
            display: flex !important;
            gap: 6px;
        }

    .message-actions button {
        font-size: 14px;
    }
</style>
