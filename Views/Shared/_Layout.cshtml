@using Microsoft.AspNetCore.Identity
@using MasterServicePlatform.Web.Models
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Master Service Platform</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />

    <link rel="stylesheet" href="~/css/site.css" />


   
</head>

<body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-sm navbar-dark bg-dark mb-4 shadow-sm">
        <div class="container-fluid">

            <!-- Logo - main menu -->
            <a class="navbar-brand text-light"
               asp-controller="Home"
               asp-action="Index">
                MasterService
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarNav" aria-controls="navbarNav"
                    aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">

                <!-- LEFT -->
                <ul class="navbar-nav me-auto mb-2 mb-sm-0">

                    <li class="nav-item">
                        <a class="nav-link text-light" asp-controller="Public" asp-action="Index">
                            <i class="bi bi-search"></i> Find a Master
                        </a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link text-light" asp-controller="About" asp-action="Index">
                            <i class="bi bi-info-circle"></i> About Us
                        </a>
                    </li>


                    <li class="nav-item">
                        <a class="nav-link text-light" asp-controller="HowItWorks" asp-action="Index">
                            <i class="bi bi-lightbulb"></i> How it Works
                        </a>
                    </li>


                    <li class="nav-item">
                        <a class="nav-link text-light" asp-controller="Contact" asp-action="Index">
                            <i class="bi bi-envelope"></i> Contact
                        </a>
                    </li>


                    @* Dashboard — for Admin *@
                    @if (SignInManager.IsSignedIn(User) && User.IsInRole("Admin"))
                    {
                        <li class="nav-item">
                            <a class="nav-link text-warning" asp-controller="Home" asp-action="Index">
                                <i class="bi bi-speedometer2"></i> Dashboard
                            </a>
                        </li>
                    }
                </ul>

                <!-- RIGHT (Auth / Account) -->
                <div class="d-flex align-items-center text-light">
                    @if (SignInManager.IsSignedIn(User))
                    {
                        var currentUser = await UserManager.GetUserAsync(User);

                        // If usr deleted
                        if (currentUser == null)
                        {
                            <a class="btn btn-outline-light btn-sm me-2"
                               asp-area="Identity" asp-page="/Account/Login">
                                <i class="bi bi-box-arrow-in-right"></i> Login
                            </a>

                            <a class="btn btn-success btn-sm"
                               asp-area="Identity" asp-page="/Account/Register">
                                <i class="bi bi-person-plus"></i> Register
                            </a>
                        }
                        else
                        {
                            string initials =
                            ((currentUser.FirstName?.FirstOrDefault().ToString() ?? "")
                            + (currentUser.LastName?.FirstOrDefault().ToString() ?? "")).Trim();

                            if (string.IsNullOrWhiteSpace(initials))
                                initials = currentUser.Email.Substring(0, 1).ToUpper();


                            <div class="dropdown">
                                <button class="btn btn-outline-light btn-sm dropdown-toggle d-flex align-items-center"
                                        type="button" id="userMenu" data-bs-toggle="dropdown" aria-expanded="false">

                                    @{
                                        // User avatar
                                        string avatarToShow = currentUser.AvatarPath;

                                        // Taking master avatar if master
                                        if (currentUser.Role == UserRole.Master && currentUser.MasterId.HasValue)
                                        {
                                            var dbContext = Context.RequestServices
                                            .GetService(typeof(ApplicationDbContext)) as ApplicationDbContext;

                                            if (dbContext != null)
                                            {
                                                var master = dbContext.Masters
                                                .FirstOrDefault(m => m.Id == currentUser.MasterId.Value);

                                                if (master != null && !string.IsNullOrEmpty(master.AvatarPath))
                                                    avatarToShow = master.AvatarPath;
                                            }
                                        }
                                    }

                                    @if (!string.IsNullOrEmpty(avatarToShow))
                                    {
                                        <img src="@avatarToShow"
                                             alt="Avatar"
                                             class="me-2 rounded-circle"
                                             style="width:32px;height:32px;object-fit:cover;" />
                                    }
                                    else
                                    {
                                        <div class="user-avatar me-2">@initials</div>
                                    }

                                    @currentUser.Email
                                </button>

                                <ul class="dropdown-menu dropdown-menu-end shadow">
                                    @if (currentUser.Role == UserRole.User)
                                    {
                                        <li>
                                            <a class="dropdown-item" asp-controller="Profile" asp-action="Index">
                                                <i class="bi bi-person-circle me-2"></i> My Profile
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" asp-controller="Orders" asp-action="MyOrders">
                                                <i class="bi bi-list-check me-2"></i> My Orders
                                            </a>
                                        </li>
                                    }
                                    else if (currentUser.Role == UserRole.Master)
                                    {
                                        <li>
                                            <a class="dropdown-item" asp-controller="MasterProfile" asp-action="Index">
                                                <i class="bi bi-tools me-2"></i> My Master Profile
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" asp-controller="Orders" asp-action="ForMaster">
                                                <i class="bi bi-briefcase me-2"></i> Orders for Me
                                            </a>
                                        </li>
                                    }
                                    else if (currentUser.Role == UserRole.Admin)
                                    {
                                        <li>
                                            <a class="dropdown-item" asp-controller="Admin" asp-action="Dashboard">
                                                <i class="bi bi-bar-chart-line-fill me-2"></i> Admin Dashboard
                                            </a>
                                        </li>
                                    }

                                    <li><hr class="dropdown-divider" /></li>

                                    <li>
                                        <form asp-area="Identity" asp-page="/Account/Logout" method="post" class="m-0">
                                            <button type="submit" class="dropdown-item text-danger">
                                                <i class="bi bi-box-arrow-right me-2"></i> Logout
                                            </button>
                                        </form>
                                    </li>
                                </ul>
                            </div>
                        }
                    }
                    else
                    {
                        <a class="btn btn-outline-light btn-sm me-2"
                           asp-area="Identity" asp-page="/Account/Login">
                            <i class="bi bi-box-arrow-in-right"></i> Login
                        </a>

                        <a class="btn btn-success btn-sm"
                           asp-area="Identity" asp-page="/Account/Register">
                            <i class="bi bi-person-plus"></i> Register
                        </a>
                    }

                </div>

                <!-- VERSION -->
                <span class="navbar-text text-light small ms-3">
                    v1.0 · @DateTime.Now.Year
                </span>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="container mb-5">
        @RenderBody()
    </main>

    <!-- FOOTER -->
    <footer class="bg-light text-center py-3 border-top">
        <small class="text-muted">© @DateTime.Now.Year — Master Service Platform</small>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    @RenderSection("Scripts", required: false)

    <!-- LIGHTBOX OVERLAY -->
    <div id="imgModal"
         style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
        background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center;">

        <!-- arrow to the left -->
        <span id="prevArrow"
              onclick="prevPhoto()"
              style="position:absolute; left:25px; font-size:48px; color:white; cursor:pointer; user-select:none;">
            &#10094;
        </span>

        <img id="imgModalContent"
             style="max-width:90%; max-height:90%; border-radius:10px; box-shadow:0 0 20px black;">

        <!-- Arrow to the right -->
        <span id="nextArrow"
              onclick="nextPhoto()"
              style="position:absolute; right:25px; font-size:48px; color:white; cursor:pointer; user-select:none;">
            &#10095;
        </span>
    </div>


    <script>
        document.addEventListener("DOMContentLoaded", function () {

            let galleryPhotos = [];
            let currentIndex = 0;

            const modal = document.getElementById("imgModal");
            const modalImg = document.getElementById("imgModalContent");

            const allPhotos = document.querySelectorAll(".portfolio-photo");

            allPhotos.forEach((img, index) => {

                galleryPhotos.push(img.src);

                img.addEventListener("click", function () {
                    currentIndex = index;
                    modalImg.src = galleryPhotos[currentIndex];
                    modal.style.display = "flex";
                });
            });

            modal.addEventListener("click", function (e) {
                if (e.target === modal) {
                    modal.style.display = "none";
                }
            });

            function showPhoto() {
                modalImg.src = galleryPhotos[currentIndex];
            }

            window.nextPhoto = function () {
                currentIndex = (currentIndex + 1) % galleryPhotos.length;
                showPhoto();
            }

            window.prevPhoto = function () {
                currentIndex = (currentIndex - 1 + galleryPhotos.length) % galleryPhotos.length;
                showPhoto();
            }
        });
    </script>

</body>
</html>
